<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhotoCat - Image Gallery</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .image-card {
            transition: transform 0.2s;
        }
        .image-card:hover {
            transform: scale(1.02);
        }
        .modal {
            display: none;
        }
        .modal.active {
            display: flex;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-camera text-blue-600 text-2xl"></i>
                    <h1 class="text-2xl font-bold text-gray-800">PhotoCat</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <select id="tenantSelect" class="px-4 py-2 border rounded-lg" onchange="currentTenant = this.value; loadImages();">
                        <option value="demo">Demo Tenant</option>
                    </select>
                    <select id="modelSelect" class="px-4 py-2 border rounded-lg" title="Select tagging model">
                        <option value="siglip">SigLIP Model (Better)</option>
                        <option value="clip">CLIP Model</option>
                    </select>
                    <button onclick="connectDropbox()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                        <i class="fab fa-dropbox mr-2"></i>Connect Dropbox
                    </button>
                    <button onclick="syncDropbox()" id="syncButton" class="bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700">
                        <i class="fas fa-sync mr-2"></i>Sync
                    </button>
                    <button onclick="stopSync()" id="stopButton" class="hidden bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
                        <i class="fas fa-stop mr-2"></i>Stop
                    </button>
                    <button onclick="retagAllImages()" id="retagButton" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
                        <i class="fas fa-tags mr-2"></i>Retag All
                    </button>
                    <button onclick="showUploadModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        <i class="fas fa-upload mr-2"></i>Upload
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Search & Filters -->
    <div class="max-w-7xl mx-auto px-4 py-6">
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="md:col-span-2">
                    <input 
                        id="searchInput" 
                        type="text" 
                        placeholder="Search by filename, camera, location..." 
                        class="w-full px-4 py-2 border rounded-lg"
                        onkeyup="handleSearch()"
                    >
                </div>
                <div>
                    <select id="sortSelect" class="w-full px-4 py-2 border rounded-lg" onchange="loadImages()">
                        <option value="date_desc">Newest First</option>
                        <option value="date_asc">Oldest First</option>
                        <option value="name">By Name</option>
                    </select>
                </div>
                <div>
                    <input 
                        type="date" 
                        id="dateFilter" 
                        class="w-full px-4 py-2 border rounded-lg"
                        onchange="loadImages()"
                    >
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-gray-500 text-sm">Total Images</div>
                <div id="totalImages" class="text-3xl font-bold text-blue-600">0</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-gray-500 text-sm">With Faces</div>
                <div id="withFaces" class="text-3xl font-bold text-green-600">0</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-gray-500 text-sm">Tagged</div>
                <div id="tagged" class="text-3xl font-bold text-purple-600">0</div>
            </div>
            <div class="bg-white rounded-lg shadow p-4">
                <div class="text-gray-500 text-sm">Storage Used</div>
                <div id="storageUsed" class="text-3xl font-bold text-orange-600">0 MB</div>
            </div>
        </div>

        <!-- Sync Status -->
        <div id="syncStatus" class="hidden bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded">
            <div class="flex items-center">
                <i class="fas fa-info-circle text-blue-500 mr-3"></i>
                <div>
                    <div id="syncStatusText" class="text-sm text-gray-700"></div>
                </div>
            </div>
        </div>

        <!-- Image Gallery -->
        <div id="imageGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            <!-- Images will be loaded here -->
        </div>

        <!-- Loading -->
        <div id="loading" class="text-center py-8 hidden">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-600"></i>
            <p class="mt-2 text-gray-600">Loading images...</p>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-16 hidden">
            <i class="fas fa-images text-6xl text-gray-300 mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-600 mb-2">No images yet</h3>
            <p class="text-gray-500">Upload some images to get started</p>
        </div>
    </div>

    <!-- Image Detail Modal -->
    <div id="imageModal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-50">
        <div class="bg-white rounded-lg max-w-6xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h2 id="modalTitle" class="text-2xl font-bold text-gray-800"></h2>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2">
                        <img id="modalImage" src="" alt="" class="w-full rounded-lg shadow-lg">
                    </div>
                    <div>
                        <div class="space-y-4">
                            <div>
                                <h3 class="font-semibold text-gray-700 mb-2">Details</h3>
                                <div id="imageDetails" class="text-sm text-gray-600 space-y-1">
                                    <!-- Details will be loaded here -->
                                </div>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-700 mb-2">Camera Info</h3>
                                <div id="cameraInfo" class="text-sm text-gray-600 space-y-1">
                                    <!-- Camera info will be loaded here -->
                                </div>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-700 mb-2">Tags</h3>
                                <div id="imageTags" class="flex flex-wrap gap-2">
                                    <!-- Tags will be loaded here -->
                                </div>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-700 mb-2">People</h3>
                                <div id="imagePeople" class="flex flex-wrap gap-2">
                                    <!-- People will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center z-50">
        <div class="bg-white rounded-lg max-w-2xl w-full mx-4">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">Upload Images</h2>
                    <button onclick="closeUploadModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                    <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
                    <p class="text-gray-600 mb-4">Drag and drop images here or click to browse</p>
                    <input type="file" id="fileInput" multiple accept="image/*" class="hidden">
                    <button onclick="document.getElementById('fileInput').click()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">
                        Select Files
                    </button>
                </div>
                <div id="uploadProgress" class="mt-4 hidden">
                    <div class="bg-gray-200 rounded-full h-4">
                        <div id="progressBar" class="bg-blue-600 h-4 rounded-full transition-all" style="width: 0%"></div>
                    </div>
                    <p id="uploadStatus" class="text-center mt-2 text-gray-600"></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTenant = 'demo';
        let currentImages = [];

        async function loadImages() {
            console.log('loadImages: Starting...');
            const loading = document.getElementById('loading');
            const imageGrid = document.getElementById('imageGrid');
            const emptyState = document.getElementById('emptyState');
            
            console.log('loadImages: Showing loading spinner');
            loading.classList.remove('hidden');
            imageGrid.innerHTML = '';
            emptyState.classList.add('hidden');
            
            try {
                console.log('loadImages: Fetching images from API...');
                const response = await fetch(`/api/v1/images?limit=100`, {
                    headers: {
                        'X-Tenant-ID': currentTenant
                    }
                });
                
                console.log('loadImages: Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Loaded images:', data);
                console.log('Number of images:', data.images?.length);
                currentImages = data.images || [];
                
                console.log('loadImages: Hiding loading spinner');
                loading.classList.add('hidden');
                
                if (currentImages.length === 0) {
                    console.log('loadImages: No images, showing empty state');
                    emptyState.classList.remove('hidden');
                    return;
                }
                
                console.log('loadImages: Creating image cards...');
                // Preload thumbnail URLs for better performance
                currentImages.forEach((image, index) => {
                    console.log(`Creating card ${index + 1}/${currentImages.length}`);
                    const card = createImageCard(image);
                    imageGrid.appendChild(card);
                });
                
                console.log('loadImages: Updating stats...');
                updateStats(data);
                console.log('loadImages: Complete!');
            } catch (error) {
                console.error('Error loading images:', error);
                alert('Error loading images: ' + error.message + '\nCheck console for details.');
                loading.classList.add('hidden');
                emptyState.classList.remove('hidden');
            }
        }

        function createImageCard(image) {
            const div = document.createElement('div');
            div.className = 'image-card bg-white rounded-lg shadow overflow-hidden cursor-pointer';
            div.onclick = () => showImageDetail(image);
            
            // Group tags by category
            let tagsHTML = '';
            if (image.tags && image.tags.length > 0) {
                const byCategory = {};
                image.tags.forEach(tag => {
                    if (!byCategory[tag.category]) {
                        byCategory[tag.category] = [];
                    }
                    byCategory[tag.category].push(tag);
                });
                
                // Define category order
                const categoryOrder = ['Circus Skills', 'Costume Colors'];
                const sortedCategories = categoryOrder.filter(cat => byCategory[cat]);
                
                const categoryLines = sortedCategories.map(category => {
                    const tags = byCategory[category];
                    const tagsList = tags.map(t => 
                        `${t.keyword} (${Math.round(t.confidence * 100)}%)`
                    ).join(', ');
                    return `<div class="text-xs text-gray-600"><strong>${category}:</strong> ${tagsList}</div>`;
                }).join('');
                
                tagsHTML = `<div class="mt-2">${categoryLines}</div>`;
            }
            
            div.innerHTML = `
                <div class="aspect-square bg-gray-200 relative">
                    <img src="/api/v1/images/${image.id}/thumbnail" 
                         alt="${image.filename}" 
                         class="w-full h-full object-cover"
                         loading="lazy"
                         onerror="this.src=&quot;data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 400 400%22%3E%3Crect fill=%22%23ddd%22 width=%22400%22 height=%22400%22/%3E%3Ctext fill=%22%23999%22 x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22%3ENo Image%3C/text%3E%3C/svg%3E&quot;">
                    <a href="https://www.dropbox.com/home${encodeURIComponent(image.dropbox_path)}" 
                       target="dropbox" 
                       onclick="event.stopPropagation()" 
                       class="absolute top-2 left-2 bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-full shadow-lg transition-colors" 
                       title="Open in Dropbox">
                        <i class="fab fa-dropbox"></i>
                    </a>
                    ${image.tags_applied ? '<div class="absolute top-2 right-2 bg-green-500 text-white px-2 py-1 rounded text-xs"><i class="fas fa-tag"></i></div>' : ''}
                </div>
                <div class="p-3">
                    <p class="font-semibold text-gray-800 truncate">${image.filename}</p>
                    <p class="text-sm text-gray-500">${image.width} × ${image.height}</p>
                    <p class="text-xs text-gray-400"><i class="far fa-clock"></i> ${image.modified_time ? new Date(image.modified_time).toLocaleDateString() : 'Unknown'}</p>
                    ${image.capture_timestamp ? `<p class="text-xs text-gray-400"><i class="far fa-calendar"></i> Photo: ${new Date(image.capture_timestamp).toLocaleDateString()}</p>` : ''}
                    ${image.camera_model ? `<p class="text-xs text-gray-400 truncate">${image.camera_model}</p>` : ''}
                    ${tagsHTML}
                </div>
            `;
            
            return div;
        }

        async function showImageDetail(image) {
            const modal = document.getElementById('imageModal');
            document.getElementById('modalTitle').textContent = image.filename;
            document.getElementById('modalImage').src = `/api/v1/images/${image.id}/thumbnail`;
            
            // Fetch full details including tags
            try {
                const response = await fetch(`/api/v1/images/${image.id}`, {
                    headers: {
                        'X-Tenant-ID': currentTenant
                    }
                });
                const details = await response.json();
                
                // Details
                const detailsDiv = document.getElementById('imageDetails');
                detailsDiv.innerHTML = `
                    <div><strong>Size:</strong> ${details.width} × ${details.height}</div>
                    <div><strong>Format:</strong> ${details.format || 'Unknown'}</div>
                    <div><strong>File Size:</strong> ${formatBytes(details.file_size)}</div>
                    <div><strong>Path:</strong> ${details.dropbox_path}</div>
                    <div class="mt-3">
                        <a href="https://www.dropbox.com/home${encodeURIComponent(details.dropbox_path)}" 
                           target="dropbox" 
                           class="inline-flex items-center bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fab fa-dropbox mr-2"></i>Open in Dropbox
                        </a>
                    </div>
                `;
                
                // Camera info
                const camera = document.getElementById('cameraInfo');
                camera.innerHTML = details.camera_make ? `
                    <div><strong>Make:</strong> ${details.camera_make}</div>
                    <div><strong>Model:</strong> ${details.camera_model}</div>
                    ${details.lens_model ? `<div><strong>Lens:</strong> ${details.lens_model}</div>` : ''}
                    ${details.iso ? `<div><strong>ISO:</strong> ${details.iso}</div>` : ''}
                    ${details.aperture ? `<div><strong>Aperture:</strong> f/${details.aperture}</div>` : ''}
                ` : '<div class="text-gray-400">No camera information</div>';
                
                // Tags
                const tagsDiv = document.getElementById('imageTags');
                if (details.tags && details.tags.length > 0) {
                    tagsDiv.innerHTML = details.tags.map(tag => 
                        `<span class="inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">
                            ${tag.keyword} <span class="text-xs text-gray-500">(${Math.round(tag.confidence * 100)}%)</span>
                        </span>`
                    ).join(' ');
                } else {
                    tagsDiv.innerHTML = '<div class="text-gray-400">No tags</div>';
                }
                
                // People
                const peopleDiv = document.getElementById('imagePeople');
                peopleDiv.innerHTML = '<div class="text-gray-400">No people detected</div>';
                
            } catch (error) {
                console.error('Error loading image details:', error);
            }
            
            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('imageModal').classList.remove('active');
        }

        function showUploadModal() {
            document.getElementById('uploadModal').classList.add('active');
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').classList.remove('active');
            document.getElementById('uploadProgress').classList.add('hidden');
            document.getElementById('progressBar').style.width = '0%';
        }

        // Handle file selection
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const files = e.target.files;
            if (files.length > 0) {
                await uploadFiles(files);
            }
        });

        async function uploadFiles(files) {
            const progressDiv = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const statusText = document.getElementById('uploadStatus');
            
            progressDiv.classList.remove('hidden');
            progressBar.classList.remove('bg-red-600');
            progressBar.classList.add('bg-blue-600');
            
            const formData = new FormData();
            for (let file of files) {
                formData.append('files', file);
            }
            
            statusText.textContent = `Uploading ${files.length} image(s)...`;
            progressBar.style.width = '50%';
            
            try {
                console.log('Uploading to tenant:', currentTenant);
                const response = await fetch('/api/v1/images/upload', {
                    method: 'POST',
                    headers: {
                        'X-Tenant-ID': currentTenant
                    },
                    body: formData
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Upload failed: ${response.status} - ${errorText}`);
                }
                
                const result = await response.json();
                console.log('Upload result:', result);
                
                progressBar.style.width = '100%';
                statusText.textContent = `✓ Uploaded ${result.uploaded} image(s) successfully!`;
                
                // Reload images after a short delay
                setTimeout(() => {
                    closeUploadModal();
                    loadImages();
                }, 1500);
                
            } catch (error) {
                console.error('Upload error:', error);
                statusText.textContent = '✗ Upload failed: ' + error.message;
                progressBar.classList.remove('bg-blue-600');
                progressBar.classList.add('bg-red-600');
            }
        }

        function handleSearch() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            if (!query) {
                loadImages();
                return;
            }
            
            const filtered = currentImages.filter(img => 
                img.filename.toLowerCase().includes(query) ||
                (img.camera_model && img.camera_model.toLowerCase().includes(query))
            );
            
            const imageGrid = document.getElementById('imageGrid');
            imageGrid.innerHTML = '';
            filtered.forEach(image => {
                const card = createImageCard(image);
                imageGrid.appendChild(card);
            });
        }

        function updateStats(data) {
            document.getElementById('totalImages').textContent = data.total || 0;
            document.getElementById('withFaces').textContent = '0'; // TODO
            document.getElementById('tagged').textContent = '0'; // TODO
            document.getElementById('storageUsed').textContent = '0 MB'; // TODO
        }

        async function retagAllImages() {
            const button = document.getElementById('retagButton');
            const originalText = button.innerHTML;
            
            if (!confirm('Retag all images with current keywords? This may take a few minutes.')) {
                return;
            }
            
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Retagging...';
            
            try {
                const response = await fetch('/api/v1/retag', {
                    method: 'POST',
                    headers: {
                        'X-Tenant-ID': currentTenant
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Retag failed');
                }
                
                const result = await response.json();
                alert(`✓ Retagging complete!\n\nProcessed: ${result.processed}/${result.total} images`);
                
                // Reload images to show new tags
                loadImages();
                
            } catch (error) {
                console.error('Retag error:', error);
                alert('✗ Retagging failed: ' + error.message);
            } finally {
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }
        let syncShouldStop = false;

        function connectDropbox() {
            const tenantId = document.getElementById('tenantSelect').value;
            // Open OAuth flow in new window
            window.open(`/oauth/dropbox/authorize?tenant=${tenantId}`, 'dropbox_oauth', 'width=800,height=600');
        }

        function stopSync() {
            syncShouldStop = true;
            document.getElementById('stopButton').disabled = true;
            document.getElementById('stopButton').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Stopping...';
        }

        async function syncDropbox() {
            const syncButton = document.getElementById('syncButton');
            const stopButton = document.getElementById('stopButton');
            const originalText = syncButton.innerHTML;
            
            syncShouldStop = false;
            syncButton.disabled = true;
            syncButton.classList.add('hidden');
            stopButton.classList.remove('hidden');
            stopButton.disabled = false;
            stopButton.innerHTML = '<i class="fas fa-stop mr-2"></i>Stop';
            
            let totalProcessed = 0;
            
            try {
                const tenantId = document.getElementById('tenantSelect').value;
                const model = document.getElementById('modelSelect').value;
                let hasMore = true;
                
                while (hasMore && !syncShouldStop) {
                    syncButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Syncing (${model.toUpperCase()})... (${totalProcessed})`;
                    
                    const response = await fetch(`/api/v1/sync?model=${encodeURIComponent(model)}`, {
                        method: 'POST',
                        headers: {
                            'X-Tenant-ID': tenantId
                        }
                    });
                    
                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.detail || 'Sync failed');
                    }
                    
                    const result = await response.json();
                    totalProcessed += result.processed;
                    hasMore = result.has_more && result.processed > 0;
                    
                    // Show status message
                    if (result.status_message) {
                        const statusDiv = document.getElementById('syncStatus');
                        const statusText = document.getElementById('syncStatusText');
                        statusText.innerHTML = `<strong>${result.filename || 'Processing'}</strong><br>${result.status_message}`;
                        statusDiv.classList.remove('hidden');
                    }
                    
                    // Reload images after each image is processed
                    if (result.processed > 0) {
                        await loadImages();
                    }
                    
                    // Stop if no more images to process
                    if (!hasMore) {
                        break;
                    }
                }
                
                const status = syncShouldStop ? 'Stopped' : 'Done';
                syncButton.innerHTML = `<i class="fas fa-check mr-2"></i>${status} (${totalProcessed})`;
                
                // Hide status after a moment
                setTimeout(() => {
                    document.getElementById('syncStatus').classList.add('hidden');
                }, 3000);
                
                setTimeout(() => {
                    syncButton.innerHTML = originalText;
                    syncButton.disabled = false;
                    syncButton.classList.remove('hidden');
                    stopButton.classList.add('hidden');
                }, 2000);
                
            } catch (error) {
                console.error('Sync error:', error);
                alert('✗ Sync failed: ' + error.message);
                syncButton.disabled = false;
                syncButton.innerHTML = originalText;
                syncButton.classList.remove('hidden');
                stopButton.classList.add('hidden');
            }
        }

        function formatBytes(bytes) {
            if (!bytes) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadImages();
        });

        // Close modals on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeUploadModal();
            }
        });
    </script>
</body>
</html>
